<div class="parent-dashboard">
  <div class="page-header">
    <h1>Your Child's Requests</h1>
    <p>Review and respond to your child's campus leave requests</p>
  </div>

  @if (errorMessage()) {
    <div class="alert alert-error">
      <span class="alert-icon">‚ö†Ô∏è</span>
      {{ errorMessage() }}
    </div>
  }

  @if (isLoading()) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading requests...</p>
    </div>
  } @else if (requests().length === 0) {
    <div class="empty-state">
      <span class="empty-icon">‚úÖ</span>
      <h3>No Pending Requests</h3>
      <p>Your child doesn't have any requests waiting for your approval.</p>
    </div>
  } @else {
    <div class="requests-grid">
      @for (request of requests(); track request.id) {
        <div class="request-card">
          <div class="card-header">
            <div class="leave-type">
              <span class="type-icon">{{ getLeaveTypeIcon(request.leave_type) }}</span>
              <span class="type-label">{{ getLeaveTypeLabel(request.leave_type) }}</span>
            </div>
            <span class="status-badge pending">Needs Your Approval</span>
          </div>

          <div class="child-info">
            <div class="child-avatar">{{ request.user_name?.charAt(0) || 'C' }}</div>
            <div class="child-details">
              <span class="child-name">{{ request.user_name }}</span>
              <span class="child-room">Room {{ request.room_number }}</span>
            </div>
          </div>

          <div class="request-details">
            <div class="detail-group">
              <span class="detail-label">üìç Destination</span>
              <span class="detail-value">{{ request.destination }}</span>
            </div>

            @if (request.spending_leave_with) {
              <div class="detail-group">
                <span class="detail-label">üë• Spending Leave With</span>
                <span class="detail-value">{{ request.spending_leave_with }}</span>
              </div>
            }

            <div class="detail-group">
              <span class="detail-label">üìÖ Schedule</span>
              <div class="schedule-block">
                <div class="schedule-item">
                  <span class="schedule-label">Leaving:</span>
                  <span class="schedule-value">{{ formatShortDate(request.start_date) }}</span>
                </div>
                <div class="schedule-item">
                  <span class="schedule-label">Returning:</span>
                  <span class="schedule-value">{{ formatShortDate(request.end_date) }}</span>
                </div>
              </div>
            </div>

            <div class="detail-group">
              <span class="detail-label">üìù Reason</span>
              <span class="detail-value reason">{{ request.reason }}</span>
            </div>

            <div class="detail-group">
              <span class="detail-label">üìû Emergency Contact</span>
              <span class="detail-value">{{ request.emergency_contact }} ({{ request.emergency_phone }})</span>
            </div>
          </div>

          <div class="admin-approval">
            <span class="approval-icon">‚úì</span>
            <span class="approval-text">
              Approved by Home Dean
              @if (request.admin_reviewed_at) {
                <span class="approval-date">on {{ formatShortDate(request.admin_reviewed_at) }}</span>
              }
            </span>
          </div>

          @if (request.admin_notes) {
            <div class="admin-notes">
              <span class="notes-label">Home Dean Notes:</span>
              <span class="notes-text">{{ request.admin_notes }}</span>
            </div>
          }

          <div class="card-actions">
            <button class="btn-decline" (click)="openDeclineModal(request)">
              ‚úó Decline
            </button>
            <button class="btn-approve" (click)="openApproveModal(request)">
              ‚úì Approve
            </button>
          </div>
        </div>
      }
    </div>
  }

  <!-- Action Modal -->
  @if (showActionModal() && selectedRequest()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <button class="modal-close" (click)="closeModal()">√ó</button>
        
        <div class="modal-header" [class.approve]="actionType() === 'approve'" [class.decline]="actionType() === 'decline'">
          @if (actionType() === 'approve') {
            <span class="modal-icon">‚úì</span>
            <h2>Approve Request</h2>
          } @else {
            <span class="modal-icon">‚úó</span>
            <h2>Decline Request</h2>
          }
        </div>

        <div class="modal-body">
          @if (!showFaceVerification()) {
            <!-- Initial approval/decline confirmation -->
            <div class="request-summary">
              <p><strong>Child:</strong> {{ selectedRequest()!.user_name }}</p>
              <p><strong>Type:</strong> {{ getLeaveTypeLabel(selectedRequest()!.leave_type) }}</p>
              <p><strong>Destination:</strong> {{ selectedRequest()!.destination }}</p>
              @if (selectedRequest()!.spending_leave_with) {
                <p><strong>Spending Leave With:</strong> {{ selectedRequest()!.spending_leave_with }}</p>
              }
              <p><strong>When:</strong> {{ formatShortDate(selectedRequest()!.start_date) }} - {{ formatShortDate(selectedRequest()!.end_date) }}</p>
            </div>

            @if (actionType() === 'approve') {
              <div class="info-message approve">
                <span class="info-icon">üîê</span>
                <p>For security, we'll need to verify your identity with face recognition before approving this request.</p>
              </div>
            } @else {
              <div class="info-message decline">
                <span class="info-icon">‚ö†Ô∏è</span>
                <p>If you decline, your child will not be able to leave campus for this request.</p>
              </div>
            }

            <div class="form-group">
              <label for="parentNotes">Message for your child (optional)</label>
              <textarea 
                id="parentNotes"
                rows="3"
                placeholder="Add a message or note..."
                [ngModel]="parentNotes()"
                (ngModelChange)="parentNotes.set($event)"
              ></textarea>
            </div>
          } @else {
            <!-- Face verification step -->
            <div class="face-verification-section">
              <div class="verification-header">
                <span class="verification-icon">üîê</span>
                <h3>Identity Verification</h3>
                <p>Please capture your face to verify your identity</p>
              </div>

              @if (cameraError()) {
                <div class="camera-error">
                  <span>‚ö†Ô∏è</span> {{ cameraError() }}
                </div>
              }

              @if (verificationError()) {
                <div class="verification-error">
                  <span>‚ùå</span> {{ verificationError() }}
                </div>
              }

              <div class="camera-container">
                @if (cameraActive() && !capturedFaceImage()) {
                  <div class="camera-preview">
                    <video 
                      #verificationVideo 
                      autoplay 
                      playsinline
                      class="camera-video"
                    ></video>
                    <div class="face-frame-overlay">
                      <div class="face-frame" [class.countdown-active]="autoCapturing()"></div>
                      @if (autoCapturing() && countdown() > 0) {
                        <div class="countdown-display">{{ countdown() }}</div>
                      }
                      <span class="frame-hint">
                        @if (autoCapturing()) {
                          Hold still - capturing in {{ countdown() }}...
                        } @else {
                          Position your face within the frame
                        }
                      </span>
                    </div>
                  </div>
                  <canvas #verificationCanvas style="display: none;"></canvas>
                  <div class="camera-controls">
                    <button type="button" class="btn-capture" (click)="capturePhoto()">
                      üì∏ Capture Now
                    </button>
                    <button type="button" class="btn-cancel-camera" (click)="cancelFaceVerification()">
                      Cancel
                    </button>
                  </div>
                }

                @if (capturedFaceImage()) {
                  <div class="captured-preview">
                    <img [src]="capturedFaceImage()" alt="Captured face" class="captured-image" />
                    <div class="captured-controls">
                      <button type="button" class="btn-retake" (click)="retakePhoto()">
                        üîÑ Retake
                      </button>
                    </div>
                  </div>
                }

                @if (!cameraActive() && !capturedFaceImage()) {
                  <div class="camera-placeholder">
                    <span class="placeholder-icon">üì∑</span>
                    <p>Starting camera...</p>
                  </div>
                }
              </div>

              <div class="verification-info">
                <span class="info-icon">‚ÑπÔ∏è</span>
                <p>Your face will be compared with the photo taken during registration to confirm your identity.</p>
              </div>
            </div>
          }
        </div>

        <div class="modal-actions">
          @if (!showFaceVerification()) {
            <button class="btn-cancel" (click)="closeModal()">Cancel</button>
            <button 
              class="btn-confirm"
              [class.approve]="actionType() === 'approve'"
              [class.decline]="actionType() === 'decline'"
              [disabled]="isProcessing()"
              (click)="confirmAction()"
            >
              @if (isProcessing()) {
                Processing...
              } @else if (actionType() === 'approve') {
                Continue to Verify
              } @else {
                Yes, Decline
              }
            </button>
          } @else {
            <button class="btn-cancel" (click)="cancelFaceVerification()">Back</button>
            <button 
              class="btn-confirm approve"
              [disabled]="!capturedFaceImage() || isVerifying()"
              (click)="confirmAction()"
            >
              @if (isVerifying()) {
                <span class="spinner-small"></span> Verifying...
              } @else {
                ‚úì Verify & Approve
              }
            </button>
          }
        </div>
      </div>
    </div>
  }
</div>
