<div class="leave-requests">
  <div class="page-header">
    <div class="header-content">
      <h1>Leave Requests</h1>
      <p>Review and manage resident go-out requests</p>
    </div>
  </div>

  <!-- Tabs & Search -->
  <div class="controls">
    <div class="tabs">
      <button 
        class="tab" 
        [class.active]="activeTab() === 'pending'"
        (click)="switchTab('pending')"
      >
        Pending Review
      </button>
      <button 
        class="tab" 
        [class.active]="activeTab() === 'all'"
        (click)="switchTab('all')"
      >
        All Requests
      </button>
    </div>
    <div class="search-box">
      <input 
        type="text" 
        placeholder="Search by name, destination, room..."
        [ngModel]="searchQuery()"
        (ngModelChange)="searchQuery.set($event)"
      />
    </div>
  </div>

  @if (errorMessage()) {
    <div class="alert alert-error">
      <span class="alert-icon">‚ö†Ô∏è</span>
      {{ errorMessage() }}
    </div>
  }

  @if (isLoading()) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Loading requests...</p>
    </div>
  } @else if (filteredRequests().length === 0) {
    <div class="empty-state">
      <span class="empty-icon">üìã</span>
      <h3>No Requests Found</h3>
      <p>
        @if (activeTab() === 'pending') {
          There are no pending requests to review.
        } @else {
          No requests match your search criteria.
        }
      </p>
    </div>
  } @else {
    <div class="requests-table">
      <table>
        <thead>
          <tr>
            <th>Resident</th>
            <th>Type</th>
            <th>Schedule</th>
            <th>Destination</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (request of filteredRequests(); track request.id) {
            <tr>
              <td class="resident-cell" data-label="Resident">
                <div class="resident-info">
                  <div class="avatar">{{ getInitials(request.user_name) }}</div>
                  <div class="info">
                    <span class="name">{{ request.user_name || 'Unknown' }}</span>
                    <span class="room">Room {{ request.room_number || '-' }}</span>
                  </div>
                </div>
              </td>
              <td data-label="Type">
                <span class="type-badge">{{ getLeaveTypeLabel(request.leave_type) }}</span>
              </td>
              <td class="schedule-cell" data-label="Schedule">
                <div class="schedule">
                  <span class="date">{{ formatDate(request.start_date) }}</span>
                  <span class="separator">‚Üí</span>
                  <span class="date">{{ formatDate(request.end_date) }}</span>
                </div>
              </td>
              <td class="destination-cell" data-label="Destination">
                <span class="destination">{{ request.destination }}</span>
                <span class="reason">{{ request.reason }}</span>
              </td>
              <td data-label="Status">
                <span class="status-badge" [class]="getStatusClass(request.status)">
                  {{ getStatusLabel(request.status) }}
                </span>
              </td>
              <td class="actions-cell" data-label="Actions">
                @if (!isVpsas() && (request.status === 'pending_dean' || request.status === 'pending_admin')) {
                  <button class="btn-approve" (click)="openApproveModal(request)">
                    ‚úì Approve
                  </button>
                  <button class="btn-decline" (click)="openDeclineModal(request)">
                    ‚úó Decline
                  </button>
                } @else if (isVpsas() && request.status === 'pending_vpsas') {
                  <button class="btn-approve" (click)="openApproveModal(request)">
                    ‚úì Approve
                  </button>
                  <button class="btn-decline" (click)="openDeclineModal(request)">
                    ‚úó Decline
                  </button>
                } @else {
                  <span class="processed-info">
                    @if (isVpsas() && request.vpsas_reviewed_at) {
                      Reviewed {{ formatDate(request.vpsas_reviewed_at) }}
                    } @else if (request.admin_reviewed_at) {
                      Reviewed {{ formatDate(request.admin_reviewed_at) }}
                    }
                  </span>
                }
              </td>
            </tr>
            
            <!-- Expanded Details Row -->
            <tr class="details-row">
              <td colspan="6">
                <div class="details-content">
                  <div class="detail-item">
                    <span class="label">üìß Email:</span>
                    <span class="value">{{ request.user_email || '-' }}</span>
                  </div>
                  <div class="detail-item">
                    <span class="label">üìû Emergency Contact:</span>
                    <span class="value">{{ request.emergency_contact }} ({{ request.emergency_phone }})</span>
                  </div>
                  <div class="detail-item">
                    <span class="label">üìù Reason:</span>
                    <span class="value">{{ request.reason }}</span>
                  </div>
                  @if (request.admin_notes) {
                    <div class="detail-item">
                      <span class="label">üí¨ Home Dean Notes:</span>
                      <span class="value">{{ request.admin_notes }}</span>
                    </div>
                  }
                  @if (request.vpsas_notes) {
                    <div class="detail-item">
                      <span class="label">üí¨ VPSAS Notes:</span>
                      <span class="value">{{ request.vpsas_notes }}</span>
                    </div>
                  }
                  <div class="approval-status">
                    <div class="status-item">
                      <span class="status-label">Home Dean:</span>
                      <span class="status-value" [class]="request.admin_status === 'approved' ? 'approved' : request.admin_status === 'declined' ? 'declined' : 'pending'">
                        {{ request.admin_status | titlecase }}
                      </span>
                    </div>
                    <div class="status-item">
                      <span class="status-label">Parent:</span>
                      <span class="status-value" [class]="request.parent_status === 'approved' ? 'approved' : request.parent_status === 'declined' ? 'declined' : request.parent_status === 'not_required' ? 'na' : 'pending'">
                        {{ request.parent_status === 'not_required' ? 'N/A' : (request.parent_status | titlecase) }}
                      </span>
                    </div>
                    <div class="status-item">
                      <span class="status-label">VPSAS:</span>
                      <span class="status-value" [class]="request.vpsas_status === 'approved' ? 'approved' : request.vpsas_status === 'declined' ? 'declined' : 'pending'">
                        {{ request.vpsas_status | titlecase }}
                      </span>
                    </div>
                    <div class="status-item">
                      <span class="status-label">QR Code:</span>
                      <span class="status-value" [class]="request.qr_code ? 'approved' : 'pending'">
                        {{ request.qr_code ? 'Generated' : 'Not Yet' }}
                      </span>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  <!-- Action Modal -->
  @if (showActionModal() && selectedRequest()) {
    <div class="modal-overlay" (click)="closeModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <button class="modal-close" (click)="closeModal()">√ó</button>
        
        <h2>
          @if (actionType() === 'approve') {
            Approve Request
          } @else {
            Decline Request
          }
        </h2>

        <div class="modal-body">
          <div class="request-summary">
            <p><strong>Resident:</strong> {{ selectedRequest()!.user_name }}</p>
            <p><strong>Type:</strong> {{ getLeaveTypeLabel(selectedRequest()!.leave_type) }}</p>
            <p><strong>Destination:</strong> {{ selectedRequest()!.destination }}</p>
            @if (selectedRequest()!.spending_leave_with) {
              <p><strong>Spending Leave With:</strong> {{ selectedRequest()!.spending_leave_with }}</p>
            }
            <p><strong>Schedule:</strong> {{ formatDate(selectedRequest()!.start_date) }} - {{ formatDate(selectedRequest()!.end_date) }}</p>
          </div>

          <div class="form-group">
            <label for="adminNotes">Notes (optional)</label>
            <textarea 
              id="adminNotes"
              rows="3"
              placeholder="Add any notes or comments..."
              [ngModel]="adminNotes()"
              (ngModelChange)="adminNotes.set($event)"
            ></textarea>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn-cancel" (click)="closeModal()">Cancel</button>
          <button 
            class="btn-confirm"
            [class.approve]="actionType() === 'approve'"
            [class.decline]="actionType() === 'decline'"
            [disabled]="isProcessing()"
            (click)="confirmAction()"
          >
            @if (isProcessing()) {
              Processing...
            } @else if (actionType() === 'approve') {
              Confirm Approval
            } @else {
              Confirm Decline
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>
